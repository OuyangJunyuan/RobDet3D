# iou_guided_suppression 错误
写成了如下，因此当n非0时就会直接返回，令所有raw_pred都拿去插入instance bank
最终第二轮发掘就找到6000个物体，而且car@R11的性能在77-79。
```python
if n or m == 0:
    return
```
# 使用最新的进行filling

# 使用pseudo mask
原因：
1. 查看log，发现0.9的分数经常可以，但是0.9的iou阈值太难了，因此最后得到的pseudo label太少了.
```shell
[2023-05-12 01:47:58,050 INFO ins] frame 005407 raw(12) aug(11) -> raw(5) aug(4) -> reliable(0)
[2023-05-12 01:47:58,051 INFO ins] frame 005624 raw(17) aug(17) -> raw(2) aug(1) -> reliable(0)
[2023-05-12 01:47:58,053 INFO ins] frame 002560 raw(8) aug(10) -> raw(1) aug(1) -> reliable(0)
[2023-05-12 01:47:58,054 INFO ins] frame 002816 raw(17) aug(15) -> raw(5) aug(2) -> reliable(0)
[2023-05-12 01:47:58,056 INFO ins] frame 002349 raw(15) aug(18) -> raw(8) aug(8) -> reliable(0)
[2023-05-12 01:47:58,057 INFO ins] frame 005500 raw(9) aug(8) -> raw(3) aug(3) -> reliable(0)
[2023-05-12 01:47:58,058 INFO ins] frame 002559 raw(15) aug(16) -> raw(4) aug(1) -> reliable(0)
```
解决方法
1. 动态阈值？
   1. 内部的点越多，iou阈值就可以第一点
   2. 一开始的iou可以低一点，后面再拉高。或反过来
2. 逐渐加强数据增强。。。

使用mask：
1. 使用很小的iou如0.1，能匹配上且类别一致表明此处大概率是一个物体。
2. 把raw和aug的预测3d box投影到图像上，算和pseudo box 2d的iou。语义一致且iou够就算这个box是对的。
   1. raw和aug平均值作为pseudo label。 
   2. 谁和2dbox的iou大听谁的。
   3. 用各自和2d 的iou做为权重融合两个3dbox作为pseudo label。
   4. weighted box fusion
3. 使用1和2几轮后，性能提升了。此时分数估计是比较准的，使用图像上的box和预测的box比较，即使分数低也要了。
4. 理论上，那些iou match的，但是分数低的不应该直接丢弃，可以作为soft标签。

5. 使用KBF(MS3D)或WBF来进行box fusion得到好用的box。
考虑一下mask的利用，以及是否增加额外augment。
## 版本1
使用0.1的iou3d阈值，然后使用0.8的iou2d阈值。
raw和aug对2dbox的iou都大于0.8才选择。
其余的自己和自己iou>0.9或score>0.1才行。
性能很差，车辆只有30多，行人44-46，骑行60。
```shell
┌──────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                        instance bank information                                         │
├────────────┬───────┬──────┬────────┬─────────────────────────────────┬───────────────────────────────────┤
│   class    │   gt  │ anno │ pseudo │  recall [0, 0.0, 0.1, 0.5, 0.7] │ precision [0, 0.0, 0.1, 0.5, 0.7] │
├────────────┼───────┼──────┼────────┼─────────────────────────────────┼───────────────────────────────────┤
│    Car     │ 14191 │ 3001 │  6046  │ [ 0.04  0.00  0.00  0.02  0.48] │  [ 0.08  0.00  0.00  0.03  0.88]  │
│ Pedestrian │  2203 │ 573  │  318   │ [ 0.06  0.01  0.02  0.04  0.06] │  [ 0.32  0.04  0.10  0.23  0.31]  │
│  Cyclist   │  734  │ 138  │  136   │ [ 0.06  0.00  0.00  0.04  0.12] │  [ 0.28  0.00  0.01  0.19  0.52]  │
│    all     │ 17128 │ 3712 │  6500  │ [ 0.05  0.00  0.00  0.02  0.41] │  [ 0.09  0.00  0.01  0.04  0.85]  │
└────────────┴───────┴──────┴────────┴─────────────────────────────────┴───────────────────────────────────┘
```

## 版本2
低阈值后和图像进行匹配，过了则保存不过则用高阈值来筛选可靠的。
然后用原始预测和增强预测进行融合作为可靠包围框
第二轮迭代后性能就很好了。
```shell
epochs:  66%|████████████████████████████████████████████████████████████████████████████▉                                        | 92/140 [11:19<38:19, 47.90s/it, metric=68.9, recall_0.3=(0,4063)/4392]
[2023-05-15 16:51:36,061 INFO train] Average predicted number of objects(3769 samples): 12.369                                                                                                            
[2023-05-15 16:51:36,061 INFO train] Generate label finished(sec_per_example: 0.0038 second).
[2023-05-15 16:51:36,062 INFO train] recall_roi_0.3: 0.0
[2023-05-15 16:51:36,062 INFO train] recall_rcnn_0.3: 0.9257636953182775
[2023-05-15 16:51:36,062 INFO train] recall_roi_0.5: 0.0
[2023-05-15 16:51:36,062 INFO train] recall_rcnn_0.5: 0.8756470789009614
[2023-05-15 16:51:36,062 INFO train] recall_roi_0.7: 0.0
[2023-05-15 16:51:36,062 INFO train] recall_rcnn_0.7: 0.6457136355879174
[2023-05-15 16:51:51,894 INFO train] Car AP@0.70, 0.70, 0.70:
bbox AP:96.8690, 88.9568, 88.4910
bev  AP:89.3856, 87.1666, 85.7423
3d   AP:87.1126, 77.3195, 76.4594
aos  AP:96.76, 88.71, 88.06
Car AP_R40@0.70, 0.70, 0.70:
bbox AP:98.1256, 93.4525, 91.0662
bev  AP:94.6764, 88.8976, 87.0414
3d   AP:89.8116, 80.5257, 76.3312
aos  AP:98.03, 93.14, 90.59
Car AP@0.70, 0.50, 0.50:
bbox AP:96.8690, 88.9568, 88.4910
bev  AP:97.2257, 89.0798, 88.7871
3d   AP:97.0435, 89.0045, 88.6726
aos  AP:96.76, 88.71, 88.06
Car AP_R40@0.70, 0.50, 0.50:
bbox AP:98.1256, 93.4525, 91.0662
bev  AP:98.3490, 93.7254, 93.4690
3d   AP:98.2531, 93.5782, 93.1695
aos  AP:98.03, 93.14, 90.59
Pedestrian AP@0.50, 0.50, 0.50:
bbox AP:66.8893, 62.3951, 58.5167
bev  AP:60.4909, 55.5697, 51.2133
3d   AP:55.3535, 51.7827, 47.4363
aos  AP:53.96, 50.37, 46.84
Pedestrian AP_R40@0.50, 0.50, 0.50:
bbox AP:66.7717, 62.7860, 57.8198
bev  AP:59.6176, 54.0537, 49.6437
3d   AP:54.7159, 50.1292, 45.0573
aos  AP:53.22, 49.94, 45.70
Pedestrian AP@0.50, 0.25, 0.25:
bbox AP:66.8893, 62.3951, 58.5167
bev  AP:72.1827, 68.9202, 64.3340
3d   AP:72.4476, 68.9039, 64.2381
aos  AP:53.96, 50.37, 46.84
Pedestrian AP_R40@0.50, 0.25, 0.25:
bbox AP:66.7717, 62.7860, 57.8198
bev  AP:73.0008, 69.2070, 64.0295
3d   AP:73.1092, 69.1531, 63.9756
aos  AP:53.22, 49.94, 45.70
Cyclist AP@0.50, 0.50, 0.50:
bbox AP:86.7676, 72.9748, 70.3377
bev  AP:83.9126, 65.6841, 61.8126
3d   AP:82.0442, 62.6032, 58.8472
aos  AP:86.51, 69.28, 66.57
Cyclist AP_R40@0.50, 0.50, 0.50:
bbox AP:89.4800, 74.5115, 71.2121
bev  AP:86.1211, 65.5928, 61.5041
3d   AP:82.9140, 62.6849, 58.8107
aos  AP:89.14, 70.28, 67.01
Cyclist AP@0.50, 0.25, 0.25:
bbox AP:86.7676, 72.9748, 70.3377
bev  AP:86.3393, 70.7637, 68.0546
3d   AP:86.3393, 70.7637, 68.0546
aos  AP:86.51, 69.28, 66.57
Cyclist AP_R40@0.50, 0.25, 0.25:
bbox AP:89.4800, 74.5115, 71.2121
bev  AP:90.4432, 72.0581, 68.6739
3d   AP:90.4432, 72.0579, 68.6607
aos  AP:89.14, 70.28, 67.01
```
## 版本3
插入时候更新。比较score和iou。然后使用weighted box fusion来融合？
